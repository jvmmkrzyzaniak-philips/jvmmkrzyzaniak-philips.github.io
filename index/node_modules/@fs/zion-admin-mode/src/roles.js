import axios from '@fs/zion-axios'
import { getSession } from '@fs/zion-session'
import deleteTFCache from './delete-tf-cache'

export async function getRoles() {
  const url = `/service/cmn/assignments/assignments`
  const { data } = await axios.get(url)
  return data.assignmentList
}

export async function getActiveRole() {
  try {
    const { session } = await getSession()

    const val = session.values && session.values.find((v) => v.name === 'AssignmentServiceAssignment')
    return val ? val.value : ''
  } catch (error) {
    console.error(error)
    return ''
  }
}

export function reloadIfOK(status) {
  status === 200 && typeof window !== 'undefined' && window.location.reload()
}

export async function enterRole(activeRole, role) {
  if (activeRole) {
    await exitRole(activeRole, true)
  }
  // hit the endpoint
  const url = `/service/cmn/assignments/assignments/${role}`
  const { status } = await axios.put(url)
  await deleteTFCache()
  await getSession(true)
  reloadIfOK(status)
}

export async function exitRole(role, switchingRole) {
  const url = `/service/cmn/assignments/assignments/${role}`
  const { status } = await axios.delete(url)
  await deleteTFCache()
  await getSession(true)
  !switchingRole && reloadIfOK(status)
}
